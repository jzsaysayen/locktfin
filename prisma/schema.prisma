// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enum must be defined before using it in models
enum OrderStatus {
  RECEIVED
  IN_PROGRESS
  PICKUP
  COMPLETE
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

model Order {
  id             String      @id @default(cuid())
  userId         String
  trackId        String      @unique
  customerName   String
  customerNumber String
  customerEmail  String
  price          Int         @default(0) // Set when laundry is done and weighed
  status         OrderStatus
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional fields for dashboard stats
  completedWeek  Int?
  completedMonth Int?

  // One-to-many relation
  statusHistory OrderStatusHistory[] @relation("OrderToHistory")

  @@index([trackId])
  @@index([customerName])
  @@index([status, createdAt])
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  status    OrderStatus
  timestamp DateTime    @default(now())

  // Many-to-one relation
  order Order @relation("OrderToHistory", fields: [orderId], references: [id])

  @@index([orderId, timestamp])
}

model Reservation {
  id              String            @id @default(cuid())
  reservationId   String            @unique // e.g., RES-XXXXXX for tracking
  customerName    String
  customerNumber  String
  customerEmail   String
  ipAddress       String?
  isFlagged       Boolean           @default(false)
  flagReason      String?
  
  // Reservation details (drop-off only)
  dropoffDate     DateTime          // Scheduled drop-off date
  dropoffTime     String            // e.g., "9:00 AM - 10:00 AM"
  specialInstructions String?       // Any special requests or notes
  
  status          ReservationStatus @default(PENDING)
  
  // Optional: Link to order once laundry is dropped off and weighed
  orderId         String?           @unique
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([reservationId])
  @@index([customerEmail])
  @@index([customerNumber])
  @@index([ipAddress])
  @@index([isFlagged])
  @@index([status, dropoffDate])
  @@index([dropoffDate])
}

// Track all reservation attempts (successful or blocked) for auditing & abuse detection
model ReservationAttempt {
  id             String   @id @default(cuid())
  customerName   String?
  customerNumber String?
  customerEmail  String?
  ipAddress      String?
  success        Boolean  // whether a reservation record was actually created
  reason         String?  // e.g. RATE_LIMIT, DUPLICATE_SUBMISSION, BLACKLIST, OK

  createdAt DateTime @default(now())

  @@index([customerEmail, createdAt])
  @@index([customerNumber, createdAt])
  @@index([ipAddress, createdAt])
}

// Optional blacklist system – staff can maintain entries via Prisma Studio or a future UI
enum BlacklistType {
  EMAIL
  PHONE
  IP
}

model BlacklistEntry {
  id        String        @id @default(cuid())
  type      BlacklistType
  value     String
  reason    String?
  active    Boolean       @default(true)
  createdBy String?

  createdAt DateTime @default(now())

  @@unique([type, value])
}

model UserSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  resendApiKey          String?
  emailFromAddress      String?
  pickupEmailSubject    String   @default("Your laundry is ready for pickup - Order {trackId}")
  pickupEmailMessage    String   @default("Hi {customerName},\n\nGreat news! Your laundry order is now ready for pickup.\n\nOrder Details:\n• Tracking ID: {trackId}\n• Total Amount: ₱{price}\n\nPlease bring your tracking ID when picking up your order.\n\nYou can track your order anytime at: {trackUrl}\n\nThank you for choosing LaundryLink!")
  
  // Reservation email settings
  reservationConfirmSubject String @default("Drop-off Reservation Confirmed - {reservationId}")
  reservationConfirmMessage String @default("Hi {customerName},\n\nYour laundry drop-off reservation has been confirmed!\n\nReservation Details:\n• Reservation ID: {reservationId}\n• Drop-off Date: {dropoffDate}\n• Drop-off Time: {dropoffTime}\n\nPlease bring your laundry to our shop at the scheduled time. We'll weigh your items and provide the total cost when you drop them off.\n\nThank you for choosing North End Laundry Shop!")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// NEW: Global shop settings (single source of truth)
model ShopSettings {
  id                    String   @id @default("shop-settings")
  acceptingReservations Boolean  @default(true)
  updatedBy             String?  // Track which staff member last updated
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}